# Тесты на внешний API

## Особенности таких тестов:
* могут быть нестабильными, т.к. обращаются к API другой системы, на стабильность работы которой вы не можете повлиять. Особенно, если это тестовая площадка.
* могут часто падать, если внешнее API активно дорабатывается. На каждое падение нужно вручную оценивать готовность вашей системы к изменениям. Если система готова, то тесты нужно актуализировать.

## Кто и когда должен запускать такие тесты?

<details>
<summary>Команда, использующая API</summary>

1. Могут отловить изменния, если релиз API стоит на тестовой площадке.
2. Если нет договоренности о тестовых площадках, то есть шанс, что вы узнаете о проблемах из тестов, а не от пользователей.
</details>

<details>
<summary>Команда, предоставляющая API</summary>

1. Изменения будут замечены до релиза.
2. Не всегда есть возможность запускать эти тесты (много интеграторов, интегратор - это другая компания).

На стороне разработчиков API не лежит обязанность запускать все тесты интеграторов, а лежит обязанность
1. Проверять работоспособность их продукта на своих тестах.
2. Поддерживать обратную совместимости, чтобы старые реализации использования методов не ломались.

</details>



## Пример тестов на внешний API
Рассмотрим использованием публичного API на примере https://deckofcardsapi.com. Этот API позволяет работать с колодами карт: брать колоду карт, брать карты из колоды, перемешивать колоду.

Для того, чтобы быть уверенными, что изменения в этом методе не сломают нашу интеграцию с этим сервисом, мы хотим быть уверенными в корректной работе следующих сценариев:
1. Модель данных, которую возвращает метод, всегда содержит 4 поля.
2. Количество карт зависит от количества колод, которые мы запрашиваем.
3. Признак “перемешана” возвращается корректно.
4. Статус ответа возвращается корректно.

Тестировать негативные сценарии вызова метода в нашем случае не нужно.

Мы используем библиотеку RestSharp и класс RestClient из нее. Сравнение библиотек RestSharp и HttpClient можно изучить самостоятельно [тут](https://code-maze.com/httpclient-vs-restsharp/).

# Ограничения
Чаще всего все публичные API делают ограничение на доступ к своим методам. Такое ограничение реализовывают с помощью уникального ключа - ApiKey, который выдают каждому клиенту.
ApiKey и другие секретные данные далее в курсе будем называть “секретом”. Существуют разные способы хранения секретов, например в файлах конфигурации или во внешних специальных сервисах, например [Vault](https://www.vaultproject.io/#/demo/0). Подробнее про хранение секретов можно почитать [тут](https://habr.com/ru/post/306812/).


# Рассмотрим второй пример
Напишем тесты на внешний АПИ с использованием ApiKey на примере сервиса https://dadata.ru/ . Рассмотрим метод поиска данных компании по ее ИНН. https://dadata.ru/api/find-party/


